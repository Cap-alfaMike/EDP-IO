# ============================================================================
# EDP-IO - Lint & Code Quality Workflow
# ============================================================================
# This workflow validates code formatting and quality.
# No auto-formatting‚Äîall code must be formatted locally before pushing.
#
# WHEN: Every push and pull request to main
# WHAT: Checks Black, isort, Flake8, and mypy
# ============================================================================

name: Lint & Code Quality

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: üîç Lint & Validate Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          pip install --upgrade pip
          pip install black flake8 mypy isort

      - name: Verify Black formatting
        run: |
          black --check --diff \
            --exclude="\.venv|venv|env|\.env|edp-io-api|dbt_project|\.eggs|__pycache__" \
            src/ app/ scripts/ tests/

      - name: Verify imports with isort
        run: |
          isort --check-only --diff \
            --profile=black \
            --line-length=100 \
            --skip-glob="**/.venv/**" \
            src/ app/ scripts/ tests/

      - name: Lint with Flake8
        run: |
          flake8 \
            src/ app/ scripts/ tests/ \
            --exclude=".venv,venv,edp-io-api,dbt_project,\.eggs,__pycache__" \
            --max-line-length=100 \
            --ignore=E203,W503
        continue-on-error: true

      - name: Type check with mypy
        run: |
          mypy src/ --ignore-missing-imports
        continue-on-error: true
          branch: ${{ github.ref }}
          force: false
        continue-on-error: true  # Don't fail if already up to date

  lint:
    name: üîç Lint Check
    runs-on: ubuntu-latest
    needs: format
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          pip install --upgrade pip
          pip install black flake8 mypy isort

      - name: Verify Black formatting
        run: |
          black --check --diff \
            --exclude="\.venv|venv|env|\.env|edp-io-api|dbt_project|\.eggs|__pycache__" \
            src/ app/ scripts/ tests/

      - name: Verify imports with isort
        run: |
          isort --check-only --diff \
            --profile=black \
            --line-length=100 \
            --skip-glob="**/.venv/**" \
            src/ app/ scripts/ tests/

      - name: Lint with Flake8
        run: |
          flake8 \
            src/ app/ scripts/ tests/ \
            --exclude=".venv,venv,edp-io-api,dbt_project,\.eggs,__pycache__" \
            --max-line-length=100 \
            --ignore=E203,W503
        continue-on-error: true
